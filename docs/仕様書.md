# 電話応対報告文作成補助サイト 仕様書

## 1. 概要

### 1.1. プロジェクト名

* **英名:** TeleScribe Assist
* **プロジェクト名用英名（空白文字なし）:** TeleScribeAssist
* **カタカナ読み:** テレ・スクライブ・アシスト

### 1.2. サイト概要

本ドキュメントは、電話応対の内容を担当者へチャットやメールで報告する際の、報告文作成を効率化・省力化するためのWebサイト（以下、本サイト）の仕様を定義するものである。

## 2. 機能要件

### 2.1. 基本情報（変数）セクション

* **目的:** 報告の基本情報を、テキストだけでなく多様なタイプの変数として定義し、効率的に入力・管理する。
* **変数の追加:**
    * 「変数を追加」ボタンを押すと、まず「変数名」と\*\*「変数のタイプ」\*\*（テキスト / 時刻 / 電話番号）を選択する。
* **テキスト変数:**
    * タイプで「テキスト」を選択した場合、従来通りのシンプルなテキスト入力フィールドが表示される。
* **時刻変数:**
    * タイプで「時刻」を選択した場合、以下の専用設定項目とUIが表示される。
    * **値の入力UI:**
        * 設定されたフォーマットに基づき、`[YYYY]` `/` `[MM]` `/` `[DD]` `[HH]` `:` `[mm]` のように、各要素が独立した入力フィールドに分割される。
        * これにより、Tabキーでのフォーカス移動や、`7`→`07`のような入力補完が可能になる。
        * デフォルト値として、設定された丸め処理を適用した現在時刻が自動で入力される。
    * **時刻フォーマット設定:**
        * **プリセット選択:** `YYYY/MM/DD HH:mm` や `HH:mm` といった、よく使われるフォーマットのプリセットリストから選択できる。
        * **カスタム入力:** プリセットの他に「カスタム」を選択すると、書式指定文字（`YYYY`, `MM`等）を直接入力できるテキストフィールドが表示される。
        * **ライブプレビュー:** 選択または入力されたフォーマットが、実際の時刻でどのように表示されるか（例：「プレビュー: 2025/07/01 09:42」）をリアルタイムで表示するヘルプテキストを設ける。
    * **丸め（端数処理）設定:**
        * オプションとして、時刻の丸め機能を有効化できるチェックボックスを設ける。
        * 有効化した場合、以下の2つのドロップダウンで設定を行う。
            1.  **丸める単位:** `1分` / `5分` / `10分` / `15分` / `30分` などから選択。
            2.  **丸め方:** `切り捨て` / `四捨五入` / `切り上げ` から選択。
* **初期状態:**
    * デフォルトで、「着信時刻」という名前の時刻変数が一つ設定されている。この変数は、フォーマットが`HH:mm`、丸め設定が「5分単位の切り捨て」となっている。

* **時刻変数の詳細（実装反映）:**
    * フォーマットはプリセット/カスタムを切り替え可能（`formatMode: 'preset' | 'custom'`）。
    * ±ボタンで分単位の時間調整が可能（丸め設定がOFFのときは1分単位）。
    * 現在時刻リロードボタンで即時に現在時刻へ更新。表示値との差が10分以上の場合はリロード推奨のハイライトを表示。

* **電話番号変数:**
    * 入力中は数字のみを許容し、Blur時に日本の電話番号ルールに基づいてハイフンを自動付与する（携帯/0120/0570/0800/固定電話などに対応）。
    * 右側にグループ補完候補の緑Chipを表示。曖昧検索で上位3件を提示し、入力値と完全一致の候補は非表示（電話は数字のみ比較）。

### 2.2. コア機能：報告文の組み立て（文節セクション）

* **文節コンポーネントのUI:**
    * **ドラッグハンドル:** 文節の左端に配置し、ドラッグでの順序変更を可能にする。
    * **テキスト入力フィールド:** 文節の内容を編集する。
    * **各種操作ボタン:** 「削除」「下に追加」の各ボタンを設置する。
* **順序変更（ドラッグ＆ドロップ）:**
    * ドラッグ中の要素がどこに挿入されるか、視覚的に分かりやすいアニメーションを実装する。
* **改行と空行の表現:**
    * 各文節コンポーネントは、プレビュー上では自動的に1つの改行を持つものとして扱われる。
    * **空行（空白行）を挿入する場合**は、内容が空の文節コンポーネントを作成する。これにより、文と文の間に意図的なスペースを設けることができる。

### 2.3. データ同期モデル（双方向バインディング）

* **目的:** UI上のどこで編集を行っても、関連するデータが全てリアルタイムに同期される、シームレスな編集体験を提供する。
* **同期ルール:**
    * プレビューエリア、基本情報、文節セクションの内容は相互に即時反映される。
    * プレビューエリアでの改行は、文節の増減として扱われる。具体的には、プレビューエリアのテキストを行で分割し、各行を文節コンポーネントに対応させる。**テキストが存在しない空の行は、内容が空の文節コンポーネントとして扱われる。**

### 2.4. 変数と本文の連携機能

* **未使用変数のハイライト:** 使用されていない変数は視覚的にハイライトする。
* **使用中変数の削除警告:** 使用中の変数を削除しようとすると、警告モーダルを表示し、使用箇所を明示する。

### 2.5. 文節編集コンポーネントの候補表示ロジック

* **フィールドが空でフォーカスした場合:** 「テンプレート」および「入力履歴」を一覧表示する。
* **文字入力中の場合:** 「テンプレート」または「入力履歴」を曖昧検索し、上位候補のみを表示する（完全一致の候補はChip非表示）。
* **`{{` を入力した場合:** 「基本情報」で定義されている変数一覧を候補として表示する。

### 2.6. テンプレート機能

* 「文節テンプレート」と「ブロックテンプレート」の2種類を管理する。
* **テンプレート管理モーダル:** 追加・編集・削除に対応。現在の内容を新規ブロックとして保存可能。
* **ブロック適用:**
    * 末尾に追加（append）: 文節末尾にブロックを追加。ブロック内に含まれる未登録変数は自動的に追加される。
    * 全置換（replace）: 現在の文節・変数をブロックで完全置換。変数はテンプレート内の出現名で同期（過不足なく入れ替え）。
* **自動ブロック選択:** 文節配列が既存ブロックと完全一致する場合、未選択時に該当ブロックを自動選択し、差分UIと整合する。

### 2.7. 履歴管理機能

本サイトでは、以下の4種類の履歴を管理する。

1.  **変数ごとの入力履歴:** 「基本情報」セクションの各入力フィールドの候補として使用する。
2.  **文節ごとの入力履歴:** 「文節」セクションの各入力フィールドの候補として使用する。
3.  **セッション履歴:**
    * **UI:** 画面左側に初期状態で折りたたまれたサイドパネルを設け、そこに一覧表示する。
    * **保存タイミング:** **プレビューエリアの「全体コピー」ボタンが押されたタイミング**で、その時点の報告文全体を一つの履歴として保存する。
    * **機能:**
        * **新規作成:** 現在の編集内容をすべてクリアし、まっさらな状態から報告文を作成開始するためのボタン。
        * **履歴リスト:** 保存された報告文の履歴をリスト表示し、クリックで内容を復元できる。（ChatGPTの履歴のようなイメージ）
        * **お気に入り:** 任意の履歴をお気に入り登録し、タブ切替で「お気に入りのみ」表示が可能。
        * **相対時刻表示:** 「HH:mm - n分前」等の相対表記を付与し、適切な間隔で自動更新する。
        * **重複排除:** 直前の履歴と内容が完全一致の場合は先頭要素のtimestampのみ更新。
        * **適用前確認:** 未保存変更がある場合を含め、適用前に確認ダイアログを表示。
4.  **操作履歴（Undo/Redo用）:**
    * **目的:** ユーザーの操作ミスを回復するため、「元に戻す」「やり直す」機能を提供する。
    * **保存対象:** **テキストの編集、文節の追加・削除・移動のみを対象とする。** テンプレートや変数の編集、データ管理操作といった、より大きな状態変更は対象外とする。
    * **保持件数:** 最新50件までの操作を履歴として保持する。

### 2.8. 操作履歴（Undo/Redo）機能

* **UI:** ヘッダーに「元に戻す（Undo）」と「やり直す（Redo）」のアイコンボタンを配置する。
* **挙動:** ボタンをクリックすることで、2.7-4で記録された操作履歴に基づき、一つ前の状態に戻したり、戻した操作をやり直したりできる。
* **履歴保存の対象（実装準拠）:** 文節の編集/追加/削除/並び替え、変数の編集、プレビュー編集、テンプレート適用、インポート、新規/履歴ロード、末尾追加、変数コミットなど。

### 2.9. 出力機能

* **リアルタイムプレビュー:**
    * 編集内容がリアルタイムでプレビューエリアに表示される。プレビューエリア自体も直接編集が可能。
    * **未入力変数の表現:** プレビューエリア内で、まだ値が入力されていない変数は、`{{変数名}}` のように変数名自体を装飾（例：薄い色の背景、破線の枠線など）して表示し、未入力であることが視覚的に分かるようにする。
* **コピー機能:**
    * **UI:** 「全体コピー」ボタンでプレーンテキストとしてクリップボードへコピーする。コピー完了時はトースト通知を表示する。

### 2.10. データ管理機能（インポート/エクスポート）

* **エクスポート:**
    * 全体（variables, segments, templates, inputHistory）をJSONで出力（`exportType: 'all'`）。
    * ブロックテンプレートのみをJSONで出力（`exportType: 'blocks'`）。
* **インポート:** `上書き（overwrite）/ マージ（merge）` を選択して適用。
    * JSONの妥当性検証を実施（型・必須項目）。
    * マージ時は、変数はnameでupsert、セグメントは末尾追加、templates.segmentはユニーク和集合、templates.blockはnameでupsert、入力履歴は集合・ID一意化のうえ最大件数を保持。
* **UI通知:** インポート/エクスポート完了時はトースト通知。確認・警告は共通ダイアログ（UIDialogs）で表示。

### 2.11. 管理モーダルUI

* テンプレート保存、各種管理機能、警告・確認などはモーダルウィンドウで実装する。
* **共通ダイアログ（UIDialogs）:** alert/confirm を統一デザイン・非同期APIで提供し、アプリ全体で一貫した通知/確認UIを実現する。

### 2.12. データ永続化

* 全てのユーザーデータと設定は、ブラウザの`localStorage`に保存する。

### 2.13. 変数ハイライト（入力/プレビュー）

* 文節入力とプレビュー表示では、`{{...}}` 形式の変数をオーバーレイレイヤーで視覚的に強調表示する。
* 入力テキストは透明化し、キャレット操作やキーバインドは従来どおり担保する（操作は阻害しない）。

### 2.14. 差分整列と変更可視化

* テンプレートのブロックと現在の文節配列の差分を、類似性ベースのLCS整列で解析し、追加/編集/削除を可視化する。
* 類似判定は2文字以上の最長共通部分文字列の存在で行う（軽量ロジック）。

### 2.15. テーマ切り替え

* ライト/ダークテーマを切り替え可能。現在の選択は `localStorage`（キー: `telescribeAssistTheme`）に保存され、起動前適用スクリプトによりFOUCを防止する。

## 3. 非機能要件

### 3.1. UI/UX

* **ヘッダー:** 画面最上部にヘッダーを設け、サイトタイトルと各種操作ボタン（Undo/Redo、テーマ切替、データ管理）を配置する。
* **フレームワーク:** **Tailwind CSS** を使用してスタイリングを行う。
* **デザインコンセプト:**
    * ダークモードを基調とした、モダンでシックなデザインとする。
    * **アクセントとしてのグラデーション:** 各セクションのタイトルバーなど、視線を集めたい一部の要素に限定してカラフルなグラデーションを適用し、デザインにメリハリをつける。
* **レイアウト:**
    * **メインエリアの構成:**
        * **サイドパネル（左側・折りたたみ可能）:** 「セッション履歴」を表示する。
        * **左パネル:** 上部に「プレビューセクション」、その下に「基本情報（変数）セクション」を配置する。
        * **右パネル:** 「報告文の組み立て（文節）セクション」を配置する。
    * **レスポンシブ対応:** 画面幅が狭い場合、右パネルが左パネルの下に移動する1カラムレイアウトに変化する。
* **テーマ:** ライトモードとダークモードの切り替えに対応する。
* **アニメーション:** ドラッグ＆ドロップ時など、ユーザーの操作に対して適切なアニメーションでフィードバックを行う。

### 3.2. パフォーマンス

* データ量が増加しても、UIの描画や候補の表示が遅延しないこと。
* 特に双方向データバインディングによるパフォーマンス低下に注意する。実装者は、ユーザー入力が頻繁に発生する処理（プレビューエリアのテキスト編集など）において、\*\*イベント発火を適切に制御する（例：`debounce`や`throttle`といったテクニックの適用を検討する）\*\*ことで、過剰な再描画を防ぎ、アプリケーションの応答性を維持すること。

### 3.3. 動作環境

* 主要なモダンブラウザの最新バージョン。

## 4. 実装ガイドライン

### 4.1. コンポーネントベースアーキテクチャの推奨

* 本アプリケーションは、双方向データバインディング、複数種類の履歴管理、Undo/Redo機能など、複雑な状態（State）管理を必要とする。
* そのため、実装の堅牢性やメンテナンス性を高めるために、**コンポーネントベースのアーキテクチャ**の採用を強く推奨する。
* 具体的な技術選定は実装者に委ねるが、例えば**React**やVue、SvelteのようなモダンなJavaScriptフレームワークの利用が考えられる。
* 特に、Reactを用いる場合は、状態管理ロジックをカプセル化し再利用しやすくする**React Hooks**（`useState`, `useContext`, `useReducer`など）の活用が、本仕様の複雑な要件を整理し、効率的に実装する上で非常に有効である。
* これはあくまで推奨であり、フレームワークの使用を強制するものではない。

### 4.2. エラーハンドリング方針

アプリケーション内で発生したエラーは、その重要度に応じて以下の3段階でユーザーに通知する。

* **レベル1（高）：ユーザー操作の妨げとなる致命的なエラー**
    * **例：** 不正な形式のJSONファイルによるデータインポートの失敗。
    * **対応：** ユーザーに状況を伝え、次の操作を促す**モーダルダイアログ**を表示する。
* **レベル2（中）：操作は継続できるが、一部機能が失敗したエラー**
    * **例：** （将来的な拡張で）ネットワーク起因の一時的な自動保存の失敗。
    * **対応：** 画面の隅に短時間表示される\*\*スナックバー（トースト）\*\*で、処理が失敗した旨を通知する。
* **レベル3（低）：ユーザーに直接通知する必要のない内部的なエラー**
    * **例：** 予期せぬデータ不整合の検知など、開発者が把握すべき問題。
    * **対応：** **ブラウザのコンソール**へエラーログを出力するに留める。

## 5. 将来的な拡張機能（優先度：低）

### 5.1. リッチテキスト編集

* 文節内の単語を**太字**, *斜体*, \~取り消し線\~, `インラインコード`, > 引用などで装飾できる機能。
* **出力形式への反映:**
    * この機能が実装された場合、2.9で定義されたコピー機能は、リッチテキスト装飾を各フォーマットに適切に変換して出力する。
    * **例:**
        * **太字** -> Markdown: `**太字**`, HTML: `<strong>太字</strong>`
        * *斜体* -> Markdown: `*斜体*`, HTML: `<em>斜体</em>`